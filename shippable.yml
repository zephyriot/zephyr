language: c

compiler: gcc

env:
    global:
        - SDK=0.9
        - ZEPHYR_SDK_INSTALL_DIR=/opt/sdk/zephyr-sdk-0.9
        - ZEPHYR_GCC_VARIANT=zephyr
        - USE_CCACHE=1
    matrix:
        - ARCH=x86 COVERAGE="-T samples -T tests/crypto"
        - ARCH=x86 COVERAGE="-T tests -e crypto"
        - ARCH=arm COVERAGE="-T samples -T tests/crypto"
        - ARCH=arm COVERAGE="-T tests -e kernel -e core"
        - ARCH=arm COVERAGE="-T tests/kernel"
        - ARCH=arc COVERAGE=""
        - ARCH=riscv32 COVERAGE=""
        - ARCH=nios2 COVERAGE=""

build:
    cache: true
    cache_dir_list:
        - ${SHIPPABLE_BUILD_DIR}/ccache
    pre_ci_boot:
        image_name: nashif/zephyr
        image_tag: master.21
        pull: true
        options: "-e HOME=/root"

    ci:
      - env
      - export CCACHE_DIR=${SHIPPABLE_BUILD_DIR}/ccache/${ARCH}/.ccache
      - echo ${CCACHE_DIR}
      - ccache -s --max-size=500M
      - source zephyr-env.sh
      - ./scripts/sanitycheck ${PLATFORMS} -a ${ARCH} ${COVERAGE} --inline-logs || ./scripts/sanitycheck ${PLATFORMS} -a ${ARCH} ${COVERAGE} --inline-logs --only-failed --outdir=out-2nd-pass
      - ccache -s
    post_ci:
      - git clean -dxf -e last_sanity.xml
      - mkdir -p shippable/testresults
    on_failure:
      - test -f ./scripts/sanity_chk/last_sanity.xml && cp ./scripts/sanity_chk/last_sanity.xml shippable/testresults/
    on_success:
      - cp ./scripts/sanity_chk/last_sanity.xml shippable/testresults/
